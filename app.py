import streamlit as st
import yfinance as yf
import pandas as pd
import altair as alt
from datetime import timedelta, date
import pprint
import re # ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã®è¡¨ç¤ºåã‹ã‚‰ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã«è¿½åŠ 

# --- éŠ˜æŸ„ãƒ»ã‚»ã‚¯ã‚¿ãƒ¼å®šç¾©ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
SECTORS = {
    "è³‡æº": {
        '5020.T': '5020 ï¼¥ï¼®ï¼¥ï¼¯ï¼³',
        '5019.T': '5019 å‡ºå…‰èˆˆç”£',
        '5021.T': '5021 ã‚³ã‚¹ãƒ¢ã‚¨ãƒãƒ«ã‚®ãƒ¼',
        '1605.T': '1605 ï¼©ï¼®ï¼°ï¼¥ï¼¸',
        '1662.T': '1662 çŸ³æ²¹è³‡æºé–‹ç™º',
        '8031.T': '8031 ä¸‰äº•ç‰©ç”£',
        '8058.T': '8058 ä¸‰è±å•†äº‹',
        '8001.T': '8001 ä¼Šè—¤å¿ å•†äº‹',
        '8002.T': '8002 ä¸¸ç´…',
        '8053.T': '8053 ä½å‹å•†äº‹',
        '8015.T': '8015 è±Šç”°é€šå•†',
        '2768.T': '2768 åŒæ—¥'
    },
    "è¦æ¨¡1": {
        '9984.T': '9984 ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯',
        '8411.T': '8411 ã¿ãšã»',
        '7203.T': '7203 ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',
        '8306.T': '8306 ä¸‰è±ï¼µï¼¦ï¼ª',
        '8316.T': '8316 ä¸‰äº•ä½å‹',
        '6758.T': '6758 ã‚½ãƒ‹ãƒ¼',
        '8766.T': '8766 æ±äº¬æµ·ä¸Š',
        '7011.T': '7011 ä¸‰è±é‡å·¥æ¥­',
        '9432.T': '9432 ï¼®ï¼´ï¼´',
        '6098.T': '6098 ãƒªã‚¯ãƒ«ãƒ¼ãƒˆ',
        '6861.T': '6861 ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹',
        '6501.T': '6501 æ—¥ç«‹è£½ä½œæ‰€',
        '7974.T': '7974 ä»»å¤©å ‚',
        '4063.T': '4063 ä¿¡è¶ŠåŒ–å­¦å·¥æ¥­',
        '7267.T': '7267 æœ¬ç”°æŠ€ç ”å·¥æ¥­',
        '7741.T': '7741 ï¼¨ï¼¯ï¼¹ï¼¡',
        '6857.T': '6857 ã‚¢ãƒ‰ãƒãƒ³ãƒ†ã‚¹ãƒˆ',
        '9434.T': '9434 ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯',
        '6503.T': '6503 ä¸‰è±é›»æ©Ÿ',
        '9433.T': '9433 ï¼«ï¼¤ï¼¤ï¼©',
        '6702.T': '6702 å¯Œå£«é€š',
        '9983.T': '9983 ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°',
        '4568.T': '4568 ç¬¬ä¸€ä¸‰å…±',
        '6701.T': '6701 æ—¥æœ¬é›»æ°—',
        '8035.T': '8035 æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³',
        '2914.T': '2914 æ—¥æœ¬ãŸã°ã“ç”£æ¥­',
        '6301.T': '6301 å°æ¾è£½ä½œæ‰€',
        '8725.T': '8725 ï¼­ï¼³ï¼†ï¼¡ï¼¤',
        '6367.T': '6367 ãƒ€ã‚¤ã‚­ãƒ³å·¥æ¥­',
        '3382.T': '3382 ã‚»ãƒ–ãƒ³ï¼†ã‚¢ã‚¤ãƒ»',
        '8750.T': '8750 ç¬¬ä¸€ç”Ÿå‘½',
        '8591.T': '8591 ã‚ªãƒªãƒƒã‚¯ã‚¹',
        '8630.T': '8630 ï¼³ï¼¯ï¼­ï¼°ï¼¯',
        '6981.T': '6981 æ‘ç”°è£½ä½œæ‰€',
        '4661.T': '4661 ã‚ªãƒªã‚¨ãƒ³ã‚¿ãƒ«ãƒ©ãƒ³ãƒ‰',
        '8801.T': '8801 ä¸‰äº•ä¸å‹•ç”£',
        '4901.T': '4901 å¯Œå£«ãƒ•ã‚¤ãƒ«ãƒ ',
        '6902.T': '6902 ãƒ‡ãƒ³ã‚½ãƒ¼',
        '4519.T': '4519 ä¸­å¤–è£½è–¬',
        '6146.T': '6146 ãƒ‡ã‚£ã‚¹ã‚³',
        '6954.T': '6954 ãƒ•ã‚¡ãƒŠãƒƒã‚¯',
        '5108.T': '5108 ãƒ–ãƒªãƒ‚ã‚¹ãƒˆãƒ³',
        '7751.T': '7751 ã‚­ãƒ¤ãƒãƒ³',
        '2802.T': '2802 å‘³ã®ç´ ',
        '6752.T': '6752 ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯',
        '8308.T': '8308 ã‚Šããª',
        '8802.T': '8802 ä¸‰è±åœ°æ‰€',
        '4543.T': '4543 ãƒ†ãƒ«ãƒ¢',
        '8604.T': '8604 é‡æ‘',
        '4578.T': '4578 å¤§å¡š',
        '6723.T': '6723 ãƒ«ãƒã‚µã‚¹',
        '6762.T': '6762 ï¼´ï¼¤ï¼«',
        '4452.T': '4452 èŠ±ç‹',
        '5401.T': '5401 æ—¥æœ¬è£½é‰„',
        '7269.T': '7269 ã‚¹ã‚ºã‚­',
        '1925.T': '1925 å¤§å’Œãƒã‚¦ã‚¹å·¥æ¥­',
        '7936.T': '7936 ã‚¢ã‚·ãƒƒã‚¯ã‚¹',
        '9022.T': '9022 æ±æµ·æ—…å®¢é‰„é“',
        '5802.T': '5802 ä½å‹é›»æ°—å·¥æ¥­',
        '8309.T': '8309 ä¸‰äº•ä½å‹ãƒˆãƒ©ã‚¹ãƒˆ'
    },
    "è¦æ¨¡2": {
        '4503.T': '4503 ã‚¢ã‚¹ãƒ†ãƒ©ã‚¹è£½è–¬',
        '5803.T': '5803 ãƒ•ã‚¸ã‚¯ãƒ©',
        '6201.T': '6201 è±Šç”°è‡ªå‹•ç¹”æ©Ÿ',
        '2502.T': '2502 ã‚¢ã‚µãƒ’',
        '7832.T': '7832 ãƒãƒ³ãƒ€ã‚¤ãƒŠãƒ ã‚³',
        '6273.T': '6273 ï¼³ï¼­ï¼£',
        '4307.T': '4307 é‡æ‘ç·åˆç ”ç©¶æ‰€',
        '7013.T': '7013 ï¼©ï¼¨ï¼©',
        '7532.T': '7532 ãƒ‘ãƒ³ãƒ»ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒŠã‚·ãƒ§ãƒŠãƒ«',
        '9735.T': '9735 ã‚»ã‚³ãƒ ',
        '8473.T': '8473 ï¼³ï¼¢ï¼©',
        '6988.T': '6988 æ—¥æ±é›»å·¥',
        '9101.T': '9101 æ—¥æœ¬éƒµèˆ¹',
        '9531.T': '9531 æ±äº¬ç“¦æ–¯',
        '9503.T': '9503 é–¢è¥¿é›»åŠ›',
        '1928.T': '1928 ç©æ°´ãƒã‚¦ã‚¹',
        '8830.T': '8830 ä½å‹ä¸å‹•ç”£',
        '4684.T': '4684 ã‚ªãƒ¼ãƒ“ãƒƒã‚¯',
        '1812.T': '1812 é¹¿å³¶å»ºè¨­',
        '7733.T': '7733 ã‚ªãƒªãƒ³ãƒ‘ã‚¹',
        '8697.T': '8697 æ—¥æœ¬å–å¼•æ‰€',
        '9104.T': '9104 å•†èˆ¹ä¸‰äº•',
        '1801.T': '1801 å¤§æˆå»ºè¨­',
        '6326.T': '6326 ã‚¯ãƒœã‚¿',
        '7270.T': '7270 ï¼³ï¼µï¼¢ï¼¡ï¼²ï¼µ',
        '2503.T': '2503 ã‚­ãƒªãƒ³',
        '4507.T': '4507 å¡©é‡ç¾©è£½è–¬',
        '9766.T': '9766 ã‚³ãƒŠãƒŸ',
        '3659.T': '3659 ãƒã‚¯ã‚½ãƒ³',
        '9021.T': '9021 è¥¿æ—¥æœ¬æ—…å®¢é‰„é“',
        '9532.T': '9532 å¤§é˜ªç“¦æ–¯',
        '8601.T': '8601 å¤§å’Œè¨¼åˆ¸æœ¬ç¤¾',
        '9202.T': '9202 ï¼¡ï¼®ï¼¡',
        '6383.T': '6383 ãƒ€ã‚¤ãƒ•ã‚¯',
        '9697.T': '9697 ã‚«ãƒ—ã‚³ãƒ³',
        '1802.T': '1802 å¤§æ—çµ„',
        '9502.T': '9502 ä¸­éƒ¨é›»åŠ›',
        '7453.T': '7453 è‰¯å“è¨ˆç”»',
        '4689.T': '4689 ï¼¬ï¼©ï¼®ï¼¥ãƒ¤ãƒ•ãƒ¼',
        '3402.T': '3402 æ±ãƒ¬',
        '9201.T': '9201 æ—¥æœ¬èˆªç©º',
        '7309.T': '7309 ã‚·ãƒãƒ',
        '7012.T': '7012 å·å´é‡å·¥æ¥­',
        '8136.T': '8136 ã‚µãƒ³ãƒªã‚ª',
        '6361.T': '6361 èåŸè£½ä½œæ‰€',
        '6532.T': '6532 ãƒ™ã‚¤ã‚«ãƒ¬ãƒ³ãƒˆ',
        '6586.T': '6586 ãƒã‚­ã‚¿',
        '4188.T': '4188 ä¸‰è±ã‚±ãƒŸã‚«ãƒ«',
        '8113.T': '8113 ãƒ¦ãƒ‹ãƒ»ãƒãƒ£ãƒ¼ãƒ ',
        '6920.T': '6920 ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒƒã‚¯',
        '8593.T': '8593 ä¸‰è±ï¼¨ï¼£ã‚­ãƒ£ãƒ”ã‚¿ãƒ«',
        '4523.T': '4523 ã‚¨ãƒ¼ã‚¶ã‚¤',
        '9024.T': '9024 è¥¿æ­¦',
        '6504.T': '6504 å¯Œå£«é›»æ©Ÿ',
        '7186.T': '7186 ã‚³ãƒ³ã‚³ãƒ«ãƒ‡ã‚£ã‚¢',
        '5411.T': '5411 ï¼ªï¼¦ï¼¥',
        '7202.T': '7202 ã„ã™ã‚è‡ªå‹•è»Š',
        '4612.T': '4612 æ—¥æœ¬ãƒšã‚¤ãƒ³ãƒˆ',
        '3088.T': '3088 ãƒãƒ„ã‚­ãƒ¨ã‚³ã‚³ã‚«ãƒ©ï¼†ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼',
        '7550.T': '7550 ã‚¼ãƒ³ã‚·ãƒ§ãƒ¼'
    },
    "è¦æ¨¡3": {
        '4204.T': '4204 ç©æ°´åŒ–å­¦å·¥æ¥­',
        '9602.T': '9602 æ±å®',
        '7272.T': '7272 ãƒ¤ãƒãƒç™ºå‹•æ©Ÿ',
        '5713.T': '5713 ä½å‹é‡‘å±é‰±å±±',
        '1878.T': '1878 å¤§æ±å»ºè¨—',
        '4091.T': '4091 æ—¥æœ¬é…¸ç´ ',
        '3626.T': '3626 ï¼´ï¼©ï¼³',
        '9843.T': '9843 ãƒ‹ãƒˆãƒª',
        '9005.T': '9005 æ±æ€¥',
        '7701.T': '7701 å³¶æ´¥è£½ä½œæ‰€',
        '3563.T': '3563 ï¼¦ï¼¯ï¼¯ï¼¤ï¼†ï¼¬ï¼©ï¼¦ï¼¥ï¼£ï¼¯ï¼­ï¼°ï¼¡ï¼®ï¼©ï¼¥ï¼³',
        '9684.T': '9684 ã‚¹ã‚¯ã‚¦ã‚§ã‚¢ãƒ»ã‚¨ãƒ‹ãƒƒã‚¯ã‚¹ãƒ»',
        '9107.T': '9107 å·å´æ±½èˆ¹',
        '7259.T': '7259 ã‚¢ã‚¤ã‚·ãƒ³',
        '7912.T': '7912 å¤§æ—¥æœ¬å°åˆ·',
        '6869.T': '6869 ã‚·ã‚¹ãƒ¡ãƒƒã‚¯ã‚¹',
        '6841.T': '6841 æ¨ªæ²³é›»æ©Ÿ',
        '5929.T': '5929 ä¸‰å’Œ',
        '7735.T': '7735 ï¼³ï¼£ï¼²ï¼¥ï¼¥ï¼®',
        '2875.T': '2875 æ±æ´‹æ°´ç”£',
        '8331.T': '8331 åƒè‘‰éŠ€è¡Œ',
        '9435.T': '9435 å…‰é€šä¿¡',
        '4704.T': '4704 ãƒˆãƒ¬ãƒ³ãƒ‰ãƒã‚¤ã‚¯ãƒ­',
        '3003.T': '3003 ãƒ’ãƒ¥ãƒ¼ãƒªãƒƒã‚¯',
        '6479.T': '6479 ãƒŸãƒãƒ™ã‚¢ãƒŸãƒ„ãƒŸ',
        '2413.T': '2413 ã‚¨ãƒ ã‚¹ãƒªãƒ¼',
        '7167.T': '7167 ã‚ã¶ã',
        '5334.T': '5334 æ—¥æœ¬ç‰¹æ®Šé™¶æ¥­',
        '1911.T': '1911 ä½å‹æ—æ¥­',
        '2702.T': '2702 æ—¥æœ¬ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰',
        '4062.T': '4062 ã‚¤ãƒ“ãƒ‡ãƒ³',
        '2801.T': '2801 ã‚­ãƒƒã‚³ãƒ¼ãƒãƒ³',
        '6845.T': '6845 ã‚¢ã‚ºãƒ“ãƒ«',
        '2269.T': '2269 æ˜æ²»',
        '9719.T': '9719 ï¼³ï¼£ï¼³ï¼«',
        '8354.T': '8354 ãµããŠã‹',
        '3064.T': '3064 ï¼­ï½ï½ï½ï½”ï½ï¼²ï¼¯',
        '3038.T': '3038 ç¥æˆ¸ç‰©ç”£',
        '5406.T': '5406 ç¥æˆ¸è£½é‹¼æ‰€',
        '4004.T': '4004 ãƒ¬ã‚¾ãƒŠãƒƒã‚¯ãƒ»',
        '6465.T': '6465 ãƒ›ã‚·ã‚¶ã‚­',
        '9962.T': '9962 ãƒŸã‚¹ãƒŸæœ¬ç¤¾',
        '9508.T': '9508 ä¹å·é›»åŠ›',
        '3289.T': '3289 æ±æ€¥ä¸å‹•ç”£',
        '6645.T': '6645 ã‚ªãƒ ãƒ­ãƒ³',
        '4732.T': '4732 ãƒ¦ãƒ¼ãƒ»ã‚¨ã‚¹ãƒ»ã‚¨ã‚¹',
        '9147.T': '9147 ï¼®ï¼©ï¼°ï¼°ï¼¯ï¼®ï¼¥ï¼¸ï¼°ï¼²ï¼¥ï¼³ï¼³',
        '6417.T': '6417 ä¸‰å…±',
        '4768.T': '4768 å¤§å¡šå•†ä¼š',
        '4528.T': '4528 å°é‡è–¬å“å·¥æ¥­',
        '2897.T': '2897 æ—¥æ¸…é£Ÿå“',
        '6448.T': '6448 ãƒ–ãƒ©ã‚¶ãƒ¼å·¥æ¥­',
        '2267.T': '2267 ãƒ¤ã‚¯ãƒ«ãƒˆæœ¬ç¤¾',
        '4183.T': '4183 ä¸‰äº•åŒ–å­¦',
        '6506.T': '6506 å®‰å·é›»æ©Ÿ',
        '3092.T': '3092 ï¼ºï¼¯ï¼ºï¼¯',
        '4403.T': '4403 æ—¥æ²¹',
        '9041.T': '9041 è¿‘é‰„',
        '2587.T': '2587 ã‚µãƒ³ãƒˆãƒªãƒ¼é£Ÿå“',
        '4042.T': '4042 æ±ã‚½ãƒ¼'
    },
    "è¦æ¨¡4": {
        '9142.T': '9142 ä¹å·æ—…å®¢é‰„é“',
        '7747.T': '7747 æœæ—¥ã‚¤ãƒ³ãƒ†ãƒƒã‚¯',
        '3861.T': '3861 ç‹å­',
        '5101.T': '5101 æ¨ªæµœã‚´ãƒ ',
        '7261.T': '7261 ãƒãƒ„ãƒ€',
        '9064.T': '9064 ãƒ¤ãƒãƒˆ',
        '6028.T': '6028 ãƒ†ã‚¯ãƒãƒ—ãƒ­ãƒ»',
        '7459.T': '7459 ãƒ¡ãƒ‡ã‚£ãƒ‘ãƒ«',
        '4151.T': '4151 å”å’Œã‚­ãƒªãƒ³',
        '9506.T': '9506 æ±åŒ—é›»åŠ›',
        '4716.T': '4716 æ—¥æœ¬ã‚ªãƒ©ã‚¯ãƒ«',
        '3231.T': '3231 é‡æ‘ä¸å‹•ç”£',
        '6806.T': '6806 ãƒ’ãƒ­ã‚»é›»æ©Ÿ',
        '5332.T': '5332 ï¼´ï¼¯ï¼´ï¼¯',
        '3086.T': '3086 ï¼ªï¼ãƒ•ãƒ­ãƒ³ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°',
        '9007.T': '9007 å°ç”°æ€¥é›»é‰„',
        '5706.T': '5706 ä¸‰äº•é‡‘å±é‰±æ¥­',
        '8227.T': '8227 ã—ã¾ã‚€ã‚‰',
        '4021.T': '4021 æ—¥ç”£åŒ–å­¦',
        '4527.T': '4527 ãƒ­ãƒ¼ãƒˆè£½è–¬',
        '9143.T': '9143 ï¼³ï¼§',
        '8804.T': '8804 æ±äº¬å»ºç‰©',
        '5333.T': '5333 æ—¥æœ¬ç¢å­',
        '6965.T': '6965 æµœæ¾ãƒ›ãƒˆãƒ‹ã‚¯ã‚¹',
        '2181.T': '2181 ãƒ‘ãƒ¼ã‚½ãƒ«',
        '6113.T': '6113 ã‚¢ãƒãƒ€',
        '6460.T': '6460 ã‚»ã‚¬ã‚µãƒŸãƒ¼',
        '7003.T': '7003 ä¸‰äº•ï¼¥ï¼†ï¼³',
        '3436.T': '3436 ï¼³ï¼µï¼­ï¼£ï¼¯',
        '4088.T': '4088 ã‚¨ã‚¢ãƒ»ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼',
        '5105.T': '5105 ï¼´ï¼¯ï¼¹ï¼¯ï¼´ï¼©ï¼²ï¼¥',
        '3288.T': '3288 ã‚ªãƒ¼ãƒ—ãƒ³ãƒã‚¦ã‚¹',
        '6724.T': '6724 ã‚»ã‚¤ã‚³ãƒ¼ã‚¨ãƒ—ã‚½ãƒ³',
        '3405.T': '3405 ã‚¯ãƒ©ãƒ¬',
        '9009.T': '9009 äº¬æˆé›»é‰„',
        '8253.T': '8253 ã‚¯ãƒ¬ãƒ‡ã‚£ã‚»ã‚¾ãƒ³',
        '4186.T': '4186 æ±äº¬å¿œåŒ–å·¥æ¥­',
        '1951.T': '1951 ã‚¨ã‚¯ã‚·ã‚ª',
        '1808.T': '1808 é•·è°·å·¥',
        '3291.T': '3291 é£¯ç”°',
        '7276.T': '7276 å°ç³¸è£½ä½œæ‰€',
        '8056.T': '8056 ï¼¢ï¼©ï¼°ï¼²ï¼¯ï¼§ï¼¹',
        '6141.T': '6141 ï¼¤ï¼­ï¼§æ£®ç²¾æ©Ÿ',
        '1942.T': '1942 é–¢é›»å·¥',
        '4182.T': '4182 ä¸‰è±ç“¦æ–¯åŒ–å­¦',
        '1969.T': '1969 é«˜ç ‚ç†±å­¦å·¥æ¥­',
        '9513.T': '9513 é›»æºé–‹ç™º',
        '7649.T': '7649 ã‚¹ã‚®',
        '3391.T': '3391 ãƒ„ãƒ«ãƒ',
        '6856.T': '6856 å €å ´è£½ä½œæ‰€',
        '2371.T': '2371 ã‚«ã‚«ã‚¯ã‚³ãƒ ',
        '6269.T': '6269 ä¸‰äº•æµ·æ´‹é–‹ç™º',
        '4613.T': '4613 é–¢è¥¿ãƒšã‚¤ãƒ³ãƒˆ',
        '5947.T': '5947 ãƒªãƒ³ãƒŠã‚¤',
        '8252.T': '8252 ä¸¸äº•',
        '9006.T': '9006 äº¬æµœæ€¥è¡Œé›»é‰„',
        '5444.T': '5444 å¤§å’Œå·¥æ¥­',
        '9065.T': '9065 å±±ä¹',
        '3349.T': '3349 ã‚³ã‚¹ãƒ¢ã‚¹è–¬å“',
        '1721.T': '1721 ã‚³ãƒ ã‚·ã‚¹'
    },
    "è¦æ¨¡5": {
        '6305.T': '6305 æ—¥ç«‹å»ºæ©Ÿ',
        '9008.T': '9008 äº¬ç‹é›»é‰„',
        '4912.T': '4912 ãƒ©ã‚¤ã‚ªãƒ³',
        '6368.T': '6368 ã‚ªãƒ«ã‚¬ãƒ',
        '7164.T': '7164 å…¨å›½ä¿è¨¼',
        '4980.T': '4980 ãƒ‡ã‚¯ã‚»ãƒªã‚¢ãƒ«ã‚º',
        '7729.T': '7729 æ±äº¬ç²¾å¯†',
        '3769.T': '3769 ï¼§ï¼­ï¼¯ãƒšã‚¤ãƒ¡ãƒ³ãƒˆ',
        '8088.T': '8088 å²©è°·ç”£æ¥­',
        '5344.T': '5344 ï¼­ï¼¡ï¼²ï¼µï¼·ï¼¡',
        '7951.T': '7951 ãƒ¤ãƒãƒ',
        '9989.T': '9989 ã‚µãƒ³ãƒ‰ãƒ©ãƒƒã‚°',
        '3132.T': '3132 ãƒã‚¯ãƒ‹ã‚«',
        '5991.T': '5991 æ—¥æœ¬ç™ºæ¢',
        '7988.T': '7988 ãƒ‹ãƒ•ã‚³',
        '4203.T': '4203 ä½å‹ãƒ™ãƒ¼ã‚¯ãƒ©ã‚¤ãƒˆ',
        '7211.T': '7211 ä¸‰è±è‡ªå‹•è»Šå·¥æ¥­',
        '6544.T': '6544 ã‚¸ãƒ£ãƒ‘ãƒ³ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹',
        '4681.T': '4681 ãƒªã‚¾ãƒ¼ãƒˆãƒˆãƒ©ã‚¹ãƒˆ',
        '3774.T': '3774 ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¤ãƒ‹ã‚·ã‚¢ãƒ†ã‚£ãƒ–',
        '2811.T': '2811 ã‚«ã‚´ãƒ¡',
        '5076.T': '5076 ã‚¤ãƒ³ãƒ•ãƒ­ãƒ‹ã‚¢ãƒ»',
        '1959.T': '1959 ä¹é›»å·¥',
        '4202.T': '4202 ãƒ€ã‚¤ã‚»ãƒ«',
        '6849.T': '6849 æ—¥æœ¬å…‰é›»å·¥æ¥­',
        '3107.T': '3107 ãƒ€ã‚¤ãƒ¯ãƒœã‚¦',
        '4680.T': '4680 ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¯ãƒ³',
        '3635.T': '3635 ã‚³ãƒ¼ã‚¨ãƒ¼ãƒ†ã‚¯ãƒ¢',
        '5714.T': '5714 ï¼¤ï¼¯ï¼·ï¼¡',
        '7906.T': '7906 ãƒ¨ãƒãƒƒã‚¯ã‚¹',
        '5393.T': '5393 ãƒ‹ãƒã‚¢ã‚¹',
        '8174.T': '8174 æ—¥æœ¬ç“¦æ–¯',
        '8060.T': '8060 ã‚­ãƒ¤ãƒãƒ³ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',
        '4666.T': '4666 ãƒ‘ãƒ¼ã‚¯äºŒå››',
        '3141.T': '3141 ã‚¦ã‚¨ãƒ«ã‚·ã‚¢',
        '7867.T': '7867 ã‚¿ã‚«ãƒ©ãƒˆãƒŸãƒ¼',
        '4194.T': '4194 ãƒ“ã‚¸ãƒ§ãƒŠãƒ«',
        '1332.T': '1332 ãƒ‹ãƒƒã‚¹ã‚¤',
        '4967.T': '4967 å°æ—è£½è–¬',
        '1719.T': '1719 å®‰è—¤ãƒ»é–“',
        '4385.T': '4385 ãƒ¡ãƒ«ã‚«ãƒª',
        '8020.T': '8020 å…¼æ¾',
        '3697.T': '3697 ï¼³ï¼¨ï¼©ï¼¦ï¼´',
        '8439.T': '8439 æ±äº¬ã‚»ãƒ³ãƒãƒ¥ãƒªãƒ¼',
        '2670.T': '2670 ã‚¨ãƒ¼ãƒ“ãƒ¼ã‚·ãƒ¼ãƒ»ãƒãƒ¼ãƒˆ',
        '4626.T': '4626 å¤ªé™½',
        '6728.T': '6728 ã‚¢ãƒ«ãƒãƒƒã‚¯',
        '6005.T': '6005 ä¸‰æµ¦å·¥æ¥­',
        '9069.T': '9069 ã‚»ãƒ³ã‚³ãƒ¼',
        '2871.T': '2871 ãƒ‹ãƒãƒ¬ã‚¤',
        '9507.T': '9507 å››å›½é›»åŠ›',
        '9302.T': '9302 ä¸‰äº•å€‰åº«',
        '8111.T': '8111 ã‚´ãƒ¼ãƒ«ãƒ‰ã‚¦ã‚¤ãƒ³',
        '9449.T': '9449 ï¼§ï¼­ï¼¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ',
        '9759.T': '9759 ï¼®ï¼³ï¼¤',
        '2726.T': '2726 ãƒ‘ãƒ«',
        '3923.T': '3923 ãƒ©ã‚¯ã‚¹',
        '9744.T': '9744 ãƒ¡ã‚¤ãƒ†ãƒƒã‚¯',
        '4816.T': '4816 æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³',
        '9509.T': '9509 åŒ—æµ·é“é›»åŠ›'
    },
    "è¦æ¨¡6": {
        '6436.T': '6436 ã‚¢ãƒãƒ',
        '2264.T': '2264 æ£®æ°¸ä¹³æ¥­',
        '2229.T': '2229 ã‚«ãƒ«ãƒ“ãƒ¼',
        '2327.T': '2327 æ—¥é‰„ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚º',
        '8424.T': '8424 èŠ™è“‰ç·åˆãƒªãƒ¼ã‚¹',
        '4401.T': '4401 ï¼¡ï¼¤ï¼¥ï¼«ï¼¡',
        '8279.T': '8279 ãƒ¤ã‚ªã‚³ãƒ¼',
        '7419.T': '7419 ãƒã‚¸ãƒ',
        '5805.T': '5805 ï¼³ï¼·ï¼£ï¼£',
        '2127.T': '2127 æ—¥æœ¬ï¼­ï¼†ï¼¡ã‚»ãƒ³ã‚¿ãƒ¼',
        '2531.T': '2531 å®',
        '8078.T': '8078 é˜ªå’Œèˆˆæ¥­',
        '8572.T': '8572 ã‚¢ã‚³ãƒ ',
        '6951.T': '6951 æ—¥æœ¬é›»å­',
        '3549.T': '3549 ã‚¯ã‚¹ãƒªã®ã‚¢ã‚ªã‚­',
        '2222.T': '2222 å¯¿ã‚¹ãƒ”ãƒªãƒƒãƒ„',
        '7282.T': '7282 è±Šç”°åˆæˆ',
        '2201.T': '2201 æ£®æ°¸è£½è“',
        '8410.T': '8410 ã‚»ãƒ–ãƒ³éŠ€è¡Œ',
        '3116.T': '3116 ãƒˆãƒ¨ã‚¿ç´¡ç¹”',
        '7014.T': '7014 åæ‘é€ èˆ¹æ‰€',
        '8876.T': '8876 ãƒªãƒ­',
        '6632.T': '6632 ï¼ªï¼¶ï¼£ã‚±ãƒ³ã‚¦ãƒƒãƒ‰',
        '6787.T': '6787 ãƒ¡ã‚¤ã‚³ãƒ¼',
        '6323.T': '6323 ãƒ­ãƒ¼ãƒ„ã‚§',
        '8098.T': '8098 ç¨²ç•‘ç”£æ¥­',
        '8425.T': '8425 ã¿ãšã»ãƒªãƒ¼ã‚¹',
        '6432.T': '6432 ç«¹å†…è£½ä½œæ‰€',
        '1414.T': '1414 ã‚·ãƒ§ãƒ¼ãƒœãƒ³ãƒ‰',
        '7762.T': '7762 ã‚·ãƒã‚ºãƒ³æ™‚è¨ˆ',
        '7716.T': '7716 ãƒŠã‚«ãƒ‹ã‚·',
        '3360.T': '3360 ã‚·ãƒƒãƒ—ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢',
        '5857.T': '5857 ï¼¡ï¼²ï¼¥',
        '6707.T': '6707 ã‚µãƒ³ã‚±ãƒ³é›»æ°—',
        '5471.T': '5471 å¤§åŒç‰¹æ®Šé‹¼',
        '4516.T': '4516 æ—¥æœ¬æ–°è–¬',
        '7004.T': '7004 ã‚«ãƒŠãƒ‡ãƒ“ã‚¢',
        '8130.T': '8130 ã‚µãƒ³ã‚²ãƒ„',
        '7564.T': '7564 ãƒ¯ãƒ¼ã‚¯ãƒãƒ³',
        '6590.T': '6590 èŠæµ¦ãƒ¡ã‚«ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹',
        '8850.T': '8850 ã‚¹ã‚¿ãƒ¼ãƒ„',
        '4812.T': '4812 é›»é€šç·ç ”',
        '7148.T': '7148 ï¼¦ï¼°ï¼§',
        '8515.T': '8515 ã‚¢ã‚¤ãƒ•ãƒ«',
        '8154.T': '8154 åŠ è³€é›»å­',
        '4587.T': '4587 ãƒšãƒ—ãƒãƒ‰ãƒªãƒ¼ãƒ ',
        '7994.T': '7994 ã‚ªã‚«ãƒ ãƒ©',
        '2317.T': '2317 ã‚·ã‚¹ãƒ†ãƒŠ',
        '8919.T': '8919 ã‚«ãƒã‚¿ã‚¹',
        '9418.T': '9418 ï¼µâˆ’ï¼®ï¼¥ï¼¸ï¼´ï¼¨ï¼¯ï¼¬ï¼¤ï¼©ï¼®ï¼§ï¼³',
        '7846.T': '7846 ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆ',
        '4686.T': '4686 ã‚¸ãƒ£ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ',
        '5032.T': '5032 ï¼¡ï¼®ï¼¹ï¼£ï¼¯ï¼¬ï¼¯ï¼²',
        '3765.T': '3765 ã‚¬ãƒ³ãƒ›ãƒ¼ãƒ»ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆ',
        '2154.T': '2154 ã‚ªãƒ¼ãƒ—ãƒ³ã‚¢ãƒƒãƒ—',
        '8848.T': '8848 ãƒ¬ã‚ªãƒ‘ãƒ¬ã‚¹ï¼’ï¼‘',
        '6670.T': '6670 ï¼­ï¼£ï¼ª',
        '6254.T': '6254 é‡æ‘ãƒã‚¤ã‚¯ãƒ­ãƒ»ã‚µã‚¤ã‚¨ãƒ³ã‚¹',
        '3186.T': '3186 ãƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¸',
        '7740.T': '7740 ã‚¿ãƒ ãƒ­ãƒ³'
    },
    "è¦æ¨¡7": {
        '3148.T': '3148 ã‚¯ãƒªã‚¨ã‚¤ãƒˆï¼³ï¼¤',
        '8133.T': '8133 ä¼Šè—¤å¿ ã‚¨ãƒã‚¯ã‚¹',
        '8584.T': '8584 ã‚¸ãƒ£ãƒƒã‚¯ã‚¹',
        '8194.T': '8194 ãƒ©ã‚¤ãƒ•ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
        '4722.T': '4722 ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼',
        '5423.T': '5423 æ±äº¬è£½éµ',
        '7744.T': '7744 ãƒãƒ¼ãƒªãƒ„é‹¼æ©Ÿ',
        '8923.T': '8923 ãƒˆãƒ¼ã‚»ã‚¤',
        '6101.T': '6101 ãƒ„ã‚¬ãƒŸ',
        '2685.T': '2685 ã‚¢ãƒ€ã‚¹ãƒˆãƒªã‚¢',
        '9119.T': '9119 é£¯é‡æµ·é‹',
        '1518.T': '1518 ä¸‰äº•æ¾å³¶',
        '2379.T': '2379 ãƒ‡ã‚£ãƒƒãƒ—',
        '2124.T': '2124 ã‚¸ã‚§ã‚¤ã‚¨ã‚¤ã‚·ãƒ¼ãƒªã‚¯ãƒ«ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ',
        '6966.T': '6966 ä¸‰äº•ãƒã‚¤ãƒ†ãƒƒã‚¯',
        '2678.T': '2678 ã‚¢ã‚¹ã‚¯ãƒ«',
        '9090.T': '9090 ï¼¡ï¼ºâˆ’ï¼£ï¼¯ï¼­ä¸¸å’Œ',
        '2767.T': '2767 å††è°·ãƒ•ã‚£ãƒ¼ãƒ«ã‚º',
        '7599.T': '7599 ï¼©ï¼¤ï¼¯ï¼­',
        '1419.T': '1419 ã‚¿ãƒãƒ›ãƒ¼ãƒ ',
        '2384.T': '2384 ï¼³ï¼¢ï¼³',
        '9110.T': '9110 ï¼®ï¼³ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰æµ·é‹',
        '5480.T': '5480 æ—¥æœ¬å†¶é‡‘å·¥æ¥­',
        '2760.T': '2760 æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³ãƒ‡ãƒã‚¤ã‚¹',
        '7105.T': '7105 ä¸‰è±ãƒ­ã‚¸ã‚¹ãƒã‚¯ã‚¹ãƒˆ',
        '3465.T': '3465 ã‚±ã‚¤ã‚¢ã‚¤ã‚¹ã‚¿ãƒ¼ä¸å‹•ç”£',
        '7944.T': '7944 ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ‰',
        '2168.T': '2168 ãƒ‘ã‚½ãƒŠ'
    }
}

ALL_STOCKS_MAP = {ticker: name for sector in SECTORS.values() for ticker, name in sector.items()}
ALL_SECTOR_TICKERS = list(ALL_STOCKS_MAP.keys())
ALL_TICKERS_WITH_N225 = list(set(ALL_SECTOR_TICKERS + ['^N225']))
NUM_COLS = 6

# ğŸ’¡ 5å¹´åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œã®ä¿®æ­£: ãƒ­ãƒ¼ãƒ‰æ™‚ã«ä½¿ç”¨ã™ã‚‹æœ€å¤§æœŸé–“ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
MAX_PERIOD_KEY = "5å¹´"
MAX_YF_PERIOD = "5y"
MAX_YF_INTERVAL = "1wk" # 5å¹´ãƒ‡ãƒ¼ã‚¿ã¯é€±æ¬¡ã§å–å¾—

# ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 1: æœŸé–“é¸æŠã¨ã€ãã®æœŸé–“ã«ç›¸å½“ã™ã‚‹timedeltaã‚’ã€Œ5æ—¥ã€ã«å¤‰æ›´
PERIOD_MAP = {
    "5æ—¥": timedelta(days=7), # '5d' ç›¸å½“ (ãŸã ã—ã€æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã¯yf_period="5d"ã‚’ä½¿ã†ã€‚ãƒãƒƒãƒ•ã‚¡ã‚’è€ƒæ…®ã—7æ—¥ã¨ã™ã‚‹)
    "1ãƒ¶æœˆ": timedelta(days=31), # '1mo' ç›¸å½“ (ãŸã ã—ã€æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—æ™‚ã¯yf_period="1mo"ã‚’ä½¿ã†)
    "1å¹´": timedelta(days=365), # '1y' ç›¸å½“ (é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆ‡ã‚Šå‡ºã—)
    "3å¹´": timedelta(days=365*3), # '3y' ç›¸å½“ (é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆ‡ã‚Šå‡ºã—)
    "5å¹´": timedelta(days=365*5), # '5y' ç›¸å½“ (é€±æ¬¡ãƒ‡ãƒ¼ã‚¿å…¨ä½“)
}
DEFAULT_PERIOD_KEY = "5æ—¥" # ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 2: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠè‚¢ã‚’ã€Œ5æ—¥ã€ã«å¤‰æ›´

# --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
def get_stock_name(ticker_code):
    """ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹éŠ˜æŸ„åã‚’å–å¾—ã™ã‚‹ã€‚"""
    if ticker_code == '^N225':
        return "æ—¥çµŒå¹³å‡"
    return ALL_STOCKS_MAP.get(ticker_code, ticker_code)

# --- Streamlitè¨­å®š ---
st.set_page_config(
    page_title="stock-v2.0-filter",
    page_icon=":chart_with_upwards_trend:",
    layout="wide",
)

# --- æœŸé–“é¸æŠãƒ­ã‚¸ãƒƒã‚¯ ---
period_options = list(PERIOD_MAP.keys())
selected_period_key = st.session_state.get("selectbox_period", DEFAULT_PERIOD_KEY)

st.markdown(f"# ğŸ“ˆ Stock Price Analysis")

# --------------------------------------------------------------------------------------
# --- ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆé€±æ¬¡ãƒ‡ãƒ¼ã‚¿: 5å¹´åˆ†ï¼‰ ---
# --------------------------------------------------------------------------------------
@st.cache_data(show_spinner=True, ttl=timedelta(hours=6))
def load_all_data_cached(tickers_list):
    """
    å…¨éŠ˜æŸ„ã¨æ—¥çµŒå¹³å‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æœ€å¤§æœŸé–“(5å¹´)åˆ†(é€±æ¬¡)ä¸€åº¦ã«å–å¾—ã—ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã€‚
    """
    if not tickers_list:
        return pd.DataFrame()
    unique_tickers = list(set(tickers_list))
    
    # ğŸ’¡ æœŸé–“ã‚’ MAX_YF_PERIOD ('5y') ã¨ MAX_YF_INTERVAL ('1wk') ã«å›ºå®š
    try:
        tickers_obj = yf.Tickers(unique_tickers)
        # æœŸé–“ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’æŒ‡å®šã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (5å¹´åˆ†ã€é€±æ¬¡)
        data = tickers_obj.history(period=MAX_YF_PERIOD, interval=MAX_YF_INTERVAL, auto_adjust=True)
        
        if 'Close' in data.columns.get_level_values(0):
            data_close = data["Close"]
        elif len(unique_tickers) == 1 and 'Close' in data.columns:
            data_close = data["Close"].to_frame(name=unique_tickers[0])
        else:
            return pd.DataFrame(index=pd.to_datetime([]), columns=unique_tickers)
            
    except yf.exceptions.YFRateLimitError:
        raise
    except Exception as e:
        st.error(f"yfinanceãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ (é€±æ¬¡): {e}")
        return pd.DataFrame()
        
    return data_close.dropna(axis=0, how='all').sort_index()

# --------------------------------------------------------------------------------------
# ğŸ”¥ å¤‰æ›´ç‚¹ 3: çŸ­ã„æœŸé–“ã®æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ï¼ˆyf_period_strãŒ'5d'ã«ã‚‚å¯¾å¿œï¼‰
# --------------------------------------------------------------------------------------
@st.cache_data(show_spinner=True, ttl=timedelta(minutes=30))
def load_daily_data_cached(tickers_list, yf_period_str):
    """
    çŸ­ã„æœŸé–“ï¼ˆæ—¥æ¬¡: '5d' ã¾ãŸã¯ '1mo'ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã€‚
    """
    if not tickers_list:
        return pd.DataFrame()
    unique_tickers = list(set(tickers_list))
    
    # æ—¥æ¬¡ (1d) ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    try:
        tickers_obj = yf.Tickers(unique_tickers)
        # ğŸ’¡ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ "1d" (æ—¥æ¬¡) ã«å›ºå®š
        data = tickers_obj.history(period=yf_period_str, interval="1d", auto_adjust=True)
        
        if 'Close' in data.columns.get_level_values(0):
            data_close = data["Close"]
        elif len(unique_tickers) == 1 and 'Close' in data.columns:
            data_close = data["Close"].to_frame(name=unique_tickers[0])
        else:
            return pd.DataFrame(index=pd.to_datetime([]), columns=unique_tickers)
            
    except yf.exceptions.YFRateLimitError:
        raise
    except Exception as e:
        st.error(f"yfinanceãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ (æ—¥æ¬¡): {e}")
        return pd.DataFrame()
        
    return data_close.dropna(axis=0, how='all').sort_index()


# ğŸ’¡ 5å¹´åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œã®ä¿®æ­£: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸé€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŒ‡å®šæœŸé–“ã‚’åˆ‡ã‚Šå‡ºã™é–¢æ•° (ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ãªã—)
@st.cache_data(show_spinner=False)
def filter_data_by_period(data_raw_5y, period_key):
    """
    5å¹´åˆ†ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆé€±æ¬¡ï¼‰ã‹ã‚‰ã€æŒ‡å®šã•ã‚ŒãŸæœŸé–“åˆ†ï¼ˆ1å¹´ã€3å¹´ã€5å¹´ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’æŠ½å‡ºã™ã‚‹ã€‚
    """
    if data_raw_5y.empty:
        return pd.DataFrame()
        
    delta = PERIOD_MAP[period_key]
    end_date = data_raw_5y.index.max()
    start_date = end_date - delta
    
    # é¸æŠæœŸé–“ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿ã®åˆ‡ã‚Šå‡ºã—
    filtered_data = data_raw_5y[data_raw_5y.index >= start_date].copy()
    
    # æ¬ æå€¤ã‚’åŸ‹ã‚ã‚‹ï¼ˆã‚°ãƒ©ãƒ•æç”»ã®ãŸã‚ã«ï¼‰
    filtered_data_filled = filtered_data.apply(lambda col: col.bfill().ffill(), axis=0)
    
    return filtered_data_filled

# 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸ5å¹´åˆ†ã®é€±æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾— (åˆå›ã®ã¿ãƒ­ãƒ¼ãƒ‰)
try:
    with st.spinner(f"æœ€å¤§ãƒ‡ãƒ¼ã‚¿ï¼ˆ{MAX_PERIOD_KEY}ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­..."):
        data_raw_5y = load_all_data_cached(ALL_TICKERS_WITH_N225) 
        
    if data_raw_5y.empty:
        # data_raw_5yãŒç©ºã®å ´åˆã§ã‚‚ã€æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã«é€²ã‚ã‚‹ã‚ˆã† st.stop() ã¯å‘¼ã°ãªã„
        pass
        
except yf.exceptions.YFRateLimitError:
    st.warning("YFinanceã®æ¥ç¶šåˆ¶é™ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚")
    load_all_data_cached.clear()
    st.stop()
except Exception as e:
    st.error(f"ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
    st.stop()

# --- æŸ”è»Ÿãªä¸Šæ˜‡ç‡è¨­å®šã¨æŠ½å‡ºé–¢æ•°ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
def filter_stocks_by_gain(all_data, stocks_map, min_gain_percent, max_gain_percent, selected_period_key):
    """
    å…¨éŠ˜æŸ„ã«ã¤ã„ã¦ã€æ ªä¾¡å¤‰å‹•ç‡ãŒæŒ‡å®šã®ç¯„å›²å†…ï¼ˆæœ€å°ã€œæœ€å¤§ï¼‰ã®ã‚‚ã®ã‚’æŠ½å‡ºã—ã€
    ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚­ãƒ¼ã€éŠ˜æŸ„åã‚’å€¤ã¨ã™ã‚‹å˜ä¸€ã®è¾æ›¸ã¨ã—ã¦è¿”ã™ã€‚
    ä½¿ç”¨ã™ã‚‹ all_data ã¯ã€æ—¢ã«æœŸé–“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¥æ¬¡ã¾ãŸã¯é€±æ¬¡ï¼‰ã§ã‚ã‚‹ã¨æƒ³å®šã€‚
    """
    if all_data.empty or all_data.shape[0] < 2:
        return {}, {} 
        
    # æœŸé–“ã®æœ€åˆã¨æœ€å¾Œã‚’å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±ä¸€
    start_prices = all_data.iloc[0].bfill()
    end_prices = all_data.iloc[-1].ffill()
    
    # æ—¥çµŒå¹³å‡ '^N225' ã¯é™¤å¤–
    valid_tickers = [t for t in stocks_map.keys() if t in start_prices.index and t in end_prices.index and start_prices[t] > 0]
    
    start_prices = start_prices[valid_tickers]
    end_prices = end_prices[valid_tickers]
    
    # ä¸Šæ˜‡ç‡ï¼ˆ%ï¼‰ã‚’è¨ˆç®—
    gain_percents = ((end_prices / start_prices) - 1) * 100
    
    # æœ€å°é–¾å€¤ä»¥ä¸Šã€æœ€å¤§é–¾å€¤ä»¥ä¸‹ã®éŠ˜æŸ„ã‚’æŠ½å‡º
    filtered_gain_tickers = gain_percents[
        (gain_percents >= min_gain_percent) & 
        (gain_percents <= max_gain_percent)
    ].index.tolist()
    
    filtered_stocks = {
        ticker: stocks_map[ticker]
        for ticker in filtered_gain_tickers
    } 
    return filtered_stocks, gain_percents.to_dict() # éŠ˜æŸ„ã”ã¨ã®ä¸Šæ˜‡ç‡ã‚’è¿”ã™

# --------------------------------------------------------------------------------------
# --- ã‚°ãƒ©ãƒ•æç”»é–¢æ•°ï¼ˆãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ãªã—ã€è¡¨ç¤ºåã®å¤‰æ›´ã‚ã‚Šï¼‰ ---
# --------------------------------------------------------------------------------------
def create_and_display_charts(normalized_data, period_label, y_min=0.9, y_max=1.1, selected_period_key=DEFAULT_PERIOD_KEY):
    """
    æ­£è¦åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¦ã€æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã®ã‚°ãƒ©ãƒ•ã‚’æç”»ã™ã‚‹ã€‚
    """
    current_plot_tickers = [t for t in normalized_data.columns if t != '^N225']
    if normalized_data is None or current_plot_tickers == []:
        st.info(f"{period_label}ã®ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return 
        
    has_nikkei = '^N225' in normalized_data.columns
    nikkei_data = pd.DataFrame()
    if has_nikkei:
        nikkei_data = normalized_data[['^N225']].rename(columns={'^N225': 'Price'})
        nikkei_data['Date'] = nikkei_data.index
        nikkei_data['z_index'] = 0
        
    y_domain = [y_min, y_max] 
    
    date_range = normalized_data.index.max() - normalized_data.index.min()
    
    # æœŸé–“ã«ã‚ˆã‚‹Xè»¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®åˆ¤å®š
    # ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 4: "1æ—¥" ã‚’ "5æ—¥" ã«å¤‰æ›´ã—ã¦åˆ¤å®š
    if selected_period_key in ["5æ—¥", "1ãƒ¶æœˆ"]: 
        x_format = "%m/%d" # çŸ­ã„æœŸé–“ã¯æœˆæ—¥è¡¨ç¤º
    elif date_range.days <= 400: # 1å¹´ä»¥å†…
        x_format = "%m/%d" # æœˆæ—¥è¡¨ç¤º
    elif date_range.days <= 365 * 4: # 4å¹´ä»¥å†…
        x_format = "%m" # æœˆè¡¨ç¤º
    else:
        x_format = "%Y" # å¹´è¡¨ç¤º

    for row_i in range((len(current_plot_tickers) + NUM_COLS - 1) // NUM_COLS):
        cols = st.columns(NUM_COLS)
        for col_i in range(NUM_COLS):
            idx = row_i * NUM_COLS + col_i
            if idx < len(current_plot_tickers):
                ticker = current_plot_tickers[idx]
                
                stock_data = pd.DataFrame({
                    "Date": normalized_data.index,
                    "Price": normalized_data[ticker],
                })
                stock_data['z_index'] = 1
                
                # Nikkeiã¨éŠ˜æŸ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆï¼ˆNikkeiãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                combined_data = pd.concat([stock_data, nikkei_data]).dropna(subset=['Price'])
                
                title_text = get_stock_name(ticker)
                
                base_chart = alt.Chart(combined_data).encode(
                    alt.X("Date:T", axis=alt.Axis(
                        format=x_format,
                        title=None,
                        labelAngle=0
                    )),
                    alt.Y("Price:Q", axis=alt.Axis(title=None, format=".2f")).scale(zero=False, domain=y_domain),
                ) 
                
                nikkei_line = alt.Chart(pd.DataFrame())
                if has_nikkei:
                    nikkei_line = base_chart.transform_filter(
                        alt.datum.z_index == 0
                    ).mark_line(
                        color="#A9A9A9",
                        strokeWidth=1.5
                    ).encode(
                        alt.Order("z_index:Q"),
                        tooltip=[
                            alt.Tooltip("Date:T", title="æ—¥ä»˜", format=x_format),
                            alt.Tooltip("Price:Q", title="æ—¥çµŒå¤‰å‹•ç‡", format=".2f")
                        ]
                    ) 
                
                stock_line = base_chart.transform_filter(
                    alt.datum.z_index == 1
                ).mark_line(
                    color="#C70025",
                    strokeWidth=2
                ).encode(
                    alt.Order("z_index:Q"),
                    tooltip=[
                        alt.Tooltip("Date:T", title="æ—¥ä»˜", format=x_format),
                        alt.Tooltip("Price:Q", title=f"{title_text}å¤‰å‹•ç‡", format=".2f")
                    ]
                ) 
                
                chart = (
                    nikkei_line + stock_line
                ).properties(title=f"{title_text}", height=300, width='container') 
                cell = cols[col_i].container(border=False)
                cell.altair_chart(chart, use_container_width=True)

# --------------------------------------------------------------------------------------
# --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
# --------------------------------------------------------------------------------------

# --- 2. çŠ¶æ…‹ç®¡ç†ï¼ˆUIï¼‰ ---
col_period, col_gain_container, col_y_axis_container = st.columns([1, 1, 1])

# --- åˆ†ææœŸé–“ã®é¸æŠï¼ˆå·¦å´ï¼‰ ---
with col_period:
    st.markdown("æœŸé–“")
    selected_period_key = st.selectbox(
        "åˆ†ææœŸé–“ã‚’é¸æŠ",
        options=period_options,
        index=period_options.index(st.session_state.get("selectbox_period", DEFAULT_PERIOD_KEY)) 
              if st.session_state.get("selectbox_period", DEFAULT_PERIOD_KEY) in period_options else 
              period_options.index(DEFAULT_PERIOD_KEY) if DEFAULT_PERIOD_KEY in period_options else 0,
        key="selectbox_period",
        label_visibility="collapsed"
    )

# ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 5: é¸æŠæœŸé–“ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
data_for_analysis = pd.DataFrame()
if selected_period_key in ["5æ—¥", "1ãƒ¶æœˆ"]:
    # çŸ­ã„æœŸé–“ã®å ´åˆ: æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    # ğŸ”¥ "5æ—¥"ã®ã¨ãã€yfinanceã®periodæ–‡å­—åˆ—ã¯ "5d" ã‚’ä½¿ç”¨
    yf_period_str = "5d" if selected_period_key == "5æ—¥" else "1mo"
    with st.spinner(f"æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ï¼ˆ{selected_period_key}ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­..."):
        data_for_analysis = load_daily_data_cached(ALL_TICKERS_WITH_N225, yf_period_str) 
    
    # æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã¯æœŸé–“ã§çµã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€ãã®ã¾ã¾ä½¿ç”¨
    data_filtered_by_period = data_for_analysis
    
    # 5æ—¥é¸æŠæ™‚ã€ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆãŒ2ã¤æœªæº€ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹
    if selected_period_key == "5æ—¥" and data_filtered_by_period.shape[0] < 2:
        st.warning("ã€Œ5æ—¥ã€ã®åˆ†æã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆï¼ˆæœ€ä½2ã¤ï¼‰ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åœŸæ—¥ã‚„ç¥æ—¥ãªã©ã€å¸‚å ´ãŒé–‰ã¾ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
        # é–¾å€¤è¨ˆç®—ãƒ»ã‚°ãƒ©ãƒ•æç”»ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã‚ˆã†ã€ç©ºã®ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã‚‹
        data_filtered_by_period = pd.DataFrame()
    
elif data_raw_5y.empty:
    st.error("æœ€å¤§æœŸé–“ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€åˆ†æã‚’ç¶šè¡Œã§ãã¾ã›ã‚“ã€‚")
    st.stop()
else:
    # é•·ã„æœŸé–“ã®å ´åˆ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸé€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠ½å‡º
    data_filtered_by_period = filter_data_by_period(data_raw_5y, selected_period_key)


if data_filtered_by_period.empty:
    # ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã§ã‚‚ã€é–¾å€¤å…¥åŠ›ã‚„Yè»¸è¨­å®šã¯è¡¨ç¤ºã‚’ç¶šã‘ã‚‹
    pass # è­¦å‘Šã¯ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯å†…ã§è¡Œã†ã‹ã€çµæœè¡¨ç¤ºæ™‚ã«è¡Œã†


# --- é–¾å€¤è¨­å®šï¼ˆä¸­å¤®ï¼‰ ---
with col_gain_container:
    default_min_gain = 12.0
    default_max_gain = 100.0
    max_range = 2000.0
    min_range = -100.0    
    if selected_period_key == "5æ—¥": 
        default_min_gain = 1.0 
        default_max_gain = 10.0
    elif selected_period_key == "1ãƒ¶æœˆ":
        default_min_gain = 5.0
        default_max_gain = 30.0
    elif selected_period_key == "1å¹´":
        default_min_gain = 50.0
    elif selected_period_key == "3å¹´":
        default_min_gain = 300.0
    elif selected_period_key == "5å¹´":
        default_min_gain = 500.0
    st.markdown("å¤‰å‹•ç‡") 
    max_gain_threshold = st.number_input(
        "æœ€å¤§å¤‰å‹•ç‡ (%)",
        min_value=min_range,
        max_value=max_range,
        value=default_max_gain,
        step=1.0,
        format="%.2f",
        key="max_gain_threshold_input",
        label_visibility="collapsed"
    )    
    min_gain_threshold = st.number_input(
        "æœ€å°å¤‰å‹•ç‡ (%)",
        min_value=min_range,
        max_value=max_range,
        value=default_min_gain,
        step=1.0,
        format="%.2f",
        key="min_gain_threshold_input",
        label_visibility="collapsed"
    )    
    if min_gain_threshold >= max_gain_threshold:
        st.error("æœ€å°å¤‰å‹•ç‡ã¯æœ€å¤§å¤‰å‹•ç‡ã‚ˆã‚Šã‚‚å°ã•ãè¨­å®šã—ã¦ãã ã•ã„ã€‚")
        pass

# --- æŠ½å‡ºéŠ˜æŸ„ Yè»¸ æœ€å¤§å€¤/æœ€å°å€¤è¨­å®šï¼ˆå³å´ï¼‰ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
with col_y_axis_container:
    min_ratio = 1.0 + min_gain_threshold / 100.0
    max_ratio = 1.0 + max_gain_threshold / 100.0
    buffer = 0.1 
    y_min_default = min(min_ratio, 1.0) - buffer
    y_max_default = max(max_ratio, 1.0) + buffer
    max_value_extracted_input = max(5.0, y_max_default + 1.0) 
    min_value_extracted_input = min(0.1, y_min_default - 0.5)
    st.markdown("Yè»¸") 
    y_max_extracted = st.number_input(
        "æŠ½å‡ºéŠ˜æŸ„ Yè»¸ æœ€å¤§å€¤",
        min_value=y_min_default + 0.05,
        max_value=max_value_extracted_input,
        value=y_max_default,
        step=0.05,
        format="%.2f",
        key="y_max_extracted_top", 
        label_visibility="collapsed"    )

    y_min_extracted = st.number_input(
        "æŠ½å‡ºéŠ˜æŸ„ Yè»¸ æœ€å°å€¤",
        min_value=min_value_extracted_input,
        max_value=y_max_default - 0.05,
        value=y_min_default,
        step=0.05,
        format="%.2f",
        key="y_min_extracted_bottom", 
        label_visibility="collapsed"
    )
    
    y_min_for_chart = y_min_extracted
    y_max_for_chart = y_max_extracted


# --- 4. æŠ½å‡ºçµæœã®è¡¨ç¤ºï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¨è¾æ›¸ï¼‰ï¼ˆå¤‰æ›´ãªã—ï¼‰ ---
FILTERED_STOCKS, all_gain_percents = filter_stocks_by_gain(data_filtered_by_period, ALL_STOCKS_MAP, min_gain_threshold, max_gain_threshold, selected_period_key)

st.markdown("---")
if FILTERED_STOCKS:
    col_table, col_dict = st.columns(2) 
    
    # çµ‚å€¤ã®å–å¾—
    end_prices = data_filtered_by_period.iloc[-1].ffill()
    current_prices = end_prices 
    
    results = []
    for ticker, name in FILTERED_STOCKS.items():
        if ticker in all_gain_percents:
            gain_percent = all_gain_percents[ticker]
            current_price = current_prices[ticker] 
            
            # gain_percent ã«åŸºã¥ã„ã¦è‰²åˆ†ã‘ç”¨ã®ãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
            mark = "ğŸ“ˆ" if gain_percent >= 0 else "ğŸ“‰"
            
            results.append({
                "ãƒãƒ¼ã‚¯": mark,
                "ãƒ†ã‚£ãƒƒã‚«ãƒ¼": ticker,
                "éŠ˜æŸ„å": name,
                "å¤‰å‹•ç‡ (%)": gain_percent,
                "ç¾åœ¨ã®æ ªä¾¡": current_price
            }) 
            
    if results:
        df_results = pd.DataFrame(results).set_index("ãƒ†ã‚£ãƒƒã‚«ãƒ¼").sort_values("å¤‰å‹•ç‡ (%)", ascending=False)
        display_df = df_results.copy()
        display_df["å¤‰å‹•ç‡ (%)"] = display_df["å¤‰å‹•ç‡ (%)"].apply(lambda x: f"{x:+.2f}") # ãƒ—ãƒ©ã‚¹/ãƒã‚¤ãƒŠã‚¹è¨˜å·ã‚’è¿½åŠ 
        display_df["ç¾åœ¨ã®æ ªä¾¡"] = display_df["ç¾åœ¨ã®æ ªä¾¡"].apply(lambda x: f"{x:,.2f}")
        
        with col_table:
            st.markdown(f"### ğŸ“Š æŠ½å‡ºéŠ˜æŸ„")
            st.data_editor(
                data=display_df,
                width='stretch', 
                disabled=True
            )
            
        with col_dict:
            DISPLAY_SECTORS = {
                "FILTERED": FILTERED_STOCKS,
            }
            st.markdown("### ğŸ“‹ Python")
            formatted_dict = pprint.pformat(DISPLAY_SECTORS, indent=4) # DISPLAY_SECTORS ã‚’æ•´å½¢
            st.code(f"SECTORS = {formatted_dict}", language='python', height=350) # å¤‰æ•°åã‚’ SECTORS ã«å¤‰æ›´
            
        st.markdown("---")
        st.markdown("### ğŸ“ˆ æ ªä¾¡å¤‰å‹•ç‡")
        
        if y_min_extracted >= y_max_extracted:
            st.warning("æŠ½å‡ºéŠ˜æŸ„ã® Yè»¸ã®æœ€å°å€¤ã¯æœ€å¤§å€¤ã‚ˆã‚Šã‚‚å°ã•ãè¨­å®šã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æç”»ã—ã¾ã™ã€‚")
            y_min_for_chart = y_min_default
            y_max_for_chart = y_max_default
        else:
            y_min_for_chart = y_min_extracted
            y_max_for_chart = y_max_extracted


        extracted_tickers = list(FILTERED_STOCKS.keys()) 
        
        # 1ã¤ç›®ã®ã‚°ãƒ©ãƒ•ã®æç”»å¯¾è±¡éŠ˜æŸ„ï¼ˆæŠ½å‡ºéŠ˜æŸ„å…¨ã¦ï¼‰
        plot_targets_1 = extracted_tickers 
        
        if not plot_targets_1:
            st.info("ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®æŠ½å‡ºéŠ˜æŸ„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        else:
            plot_tickers = [t for t in plot_targets_1 if t in data_filtered_by_period.columns]
            if '^N225' in data_filtered_by_period.columns:
                plot_tickers.append('^N225') 
                
            if plot_tickers and not data_filtered_by_period.empty:
                plot_data_raw = data_filtered_by_period[[c for c in plot_tickers if c in data_filtered_by_period.columns]].copy()
                
                # æ­£è¦åŒ–ã®åŸºæº–ã¯æœŸé–“ã®æœ€åˆã®ãƒ‡ãƒ¼ã‚¿
                first_valid_price = plot_data_raw.iloc[0]
                extracted_normalized = plot_data_raw / first_valid_price
                
                # ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 7: selected_period_keyãŒã€Œ5æ—¥ã€ã«å¯¾å¿œ
                create_and_display_charts(extracted_normalized, "", y_min_for_chart, y_max_for_chart, selected_period_key)
            else:
                st.info("æŠ½å‡ºã•ã‚ŒãŸéŠ˜æŸ„ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚") 

        # ====================================================================
        # ğŸ’¡ è¿½åŠ : 2ã¤ç›®ã®ã‚°ãƒ©ãƒ•ï¼ˆç•°ãªã‚‹æœŸé–“ã¨Yè»¸è¨­å®šï¼‰- ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆå¯¾å¿œ
        # ====================================================================
        st.markdown("---")
        st.markdown("### ğŸ“ˆ ä¸­æœŸé–“")
        
        target_period_key_2 = "1ãƒ¶æœˆ"
        target_index_2 = period_options.index(target_period_key_2) if target_period_key_2 in period_options else 0
        
        # ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æº–å‚™ï¼ˆéŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ï¼‰
        extracted_stock_options = [FILTERED_STOCKS[t] for t in extracted_tickers] # éŠ˜æŸ„åã®ã¿
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã«æŠ½å‡ºéŠ˜æŸ„ãƒªã‚¹ãƒˆã‚’ä¿å­˜ï¼ˆåˆæœŸå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
        if "selected_plot_tickers_2" not in st.session_state:
             # åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã€ã¾ãŸã¯æŠ½å‡ºéŠ˜æŸ„ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«æ›´æ–°
            st.session_state.selected_plot_tickers_2 = extracted_tickers
            
        # æç”»å¯¾è±¡ã‚’ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã§é¸æŠ
        # Yè»¸è¨­å®šç”¨ã®åˆ—ã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹
        col_plot_period, col_plot_y_setting, col_multiselect = st.columns([1, 1, 4]) # åˆ—å¹…ã‚’èª¿æ•´
        
        # éŠ˜æŸ„åã‹ã‚‰ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’é€†å¼•ãã™ã‚‹ãŸã‚ã®è¾æ›¸ã‚’ä½œæˆ
        # ã“ã®è¾æ›¸ã¯ã€ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¤–å´ã®ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¨æƒ³å®šã•ã‚Œã¾ã™
        # ä¾‹: name_to_ticker = {v: k for k, v in FILTERED_STOCKS.items()}
        # å®‰å…¨ã®ãŸã‚ã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã§ã‚‚å®šç¾©ï¼ˆã¾ãŸã¯åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
        # ä¾‹ã¨ã—ã¦ã€ã“ã“ã§å®šç¾©ã—ã¾ã™ï¼ˆå®Ÿéš›ã®ç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰
        name_to_ticker = {v: k for k, v in FILTERED_STOCKS.items()}
        
        with col_plot_period:
            st.markdown("æœŸé–“") 
            selected_plot_period_key = st.selectbox(
                "ã‚°ãƒ©ãƒ•æç”»æœŸé–“ã‚’é¸æŠ",
                options=period_options,
                index=period_options.index(st.session_state.get("selectbox_plot_period", target_period_key_2)) 
                             if st.session_state.get("selectbox_plot_period", target_period_key_2) in period_options else 
                             target_index_2,
                key="selectbox_plot_period",
                label_visibility="collapsed"
            )
            
        with col_multiselect:
            st.markdown("éŠ˜æŸ„") 
            selected_plot_ticker_names_2 = st.multiselect(
                "æç”»éŠ˜æŸ„ã‚’é¸æŠ",
                options=extracted_stock_options,
                default=[FILTERED_STOCKS[t] for t in st.session_state.selected_plot_tickers_2 if FILTERED_STOCKS[t] in extracted_stock_options],
                key="multiselect_plot_tickers_2",
                label_visibility="collapsed"
            )
            # é¸æŠã•ã‚ŒãŸéŠ˜æŸ„åã‹ã‚‰ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°
            selected_plot_tickers_2 = [name_to_ticker.get(name) for name in selected_plot_ticker_names_2 if name in name_to_ticker]
            st.session_state.selected_plot_tickers_2 = selected_plot_tickers_2 # æ¬¡å›ã®åˆæœŸå€¤ã®ãŸã‚ã«ä¿å­˜
            
        # ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 8: 2ã¤ç›®ã®ã‚°ãƒ©ãƒ•ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚‚ã€Œ5æ—¥ã€ã«å¯¾å¿œ
        data_plot_for_analysis_2 = pd.DataFrame()
        if selected_plot_period_key in ["5æ—¥", "1ãƒ¶æœˆ"]:
            yf_period_str_2 = "5d" if selected_plot_period_key == "5æ—¥" else "1mo"
            with st.spinner(f"æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ï¼ˆ{selected_plot_period_key}ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­..."):
                data_plot_for_analysis_2 = load_daily_data_cached(ALL_TICKERS_WITH_N225, yf_period_str_2) 
            data_plot_filtered_by_period = data_plot_for_analysis_2
        else:
            data_plot_filtered_by_period = filter_data_by_period(data_raw_5y, selected_plot_period_key)

        # 3. 2ã¤ç›®ã®ã‚°ãƒ©ãƒ•ç”¨ã®Yè»¸è¨­å®š
        plot_y_min_default = 0.9
        plot_y_max_default = 1.1
        
        # ä¿®æ­£: Yè»¸ æœ€å¤§å€¤ã¨æœ€å°å€¤ã‚’ col_plot_y_setting å†…ã«ç¸¦ã«é…ç½®
        with col_plot_y_setting:
             st.markdown("Yè»¸") 
             y_max_plot_period = st.number_input(
                "Yè»¸ æœ€å¤§å€¤",
                min_value=0.1,
                max_value=5.0,
                value=plot_y_max_default,
                step=0.05,
                format="%.2f",
                key="y_max_plot_period",
                label_visibility="collapsed"
            )        
             y_min_plot_period = st.number_input(
                "Yè»¸ æœ€å°å€¤",
                min_value=0.0,
                max_value=4.9,
                value=plot_y_min_default,
                step=0.05,
                format="%.2f",
                key="y_min_plot_period",
                label_visibility="collapsed"
            )

        if y_min_plot_period >= y_max_plot_period:
            st.warning("ã‚°ãƒ©ãƒ•æç”»ã® Yè»¸ã®æœ€å°å€¤ã¯æœ€å¤§å€¤ã‚ˆã‚Šã‚‚å°ã•ãè¨­å®šã—ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æç”»ã—ã¾ã™ã€‚")
            y_min_plot_period = plot_y_min_default
            y_max_plot_period = plot_y_max_default
            
        # 4. 2ã¤ç›®ã®ã‚°ãƒ©ãƒ•ã®æç”» (å¤‰æ›´ãªã—)
        if not data_plot_filtered_by_period.empty and selected_plot_tickers_2: # <--- é¸æŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’ä½¿ç”¨
            plot_tickers_new = [t for t in selected_plot_tickers_2 if t in data_plot_filtered_by_period.columns]
            if '^N225' in data_plot_filtered_by_period.columns:
                plot_tickers_new.append('^N225')
                
            if plot_tickers_new:
                plot_data_raw_new = data_plot_filtered_by_period[[c for c in plot_tickers_new if c in data_plot_filtered_by_period.columns]].copy()
                
                if not plot_data_raw_new.empty and plot_data_raw_new.shape[0] > 1:
                    # æ­£è¦åŒ–ã®åŸºæº–ã¯æœŸé–“ã®æœ€åˆã®ãƒ‡ãƒ¼ã‚¿
                    first_valid_price_new = plot_data_raw_new.iloc[0]
                    extracted_normalized_new = plot_data_raw_new / first_valid_price_new
                    
                    # ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 9: selected_plot_period_keyãŒã€Œ5æ—¥ã€ã«å¯¾å¿œ
                    create_and_display_charts(extracted_normalized_new, selected_plot_period_key, y_min_plot_period, y_max_plot_period, selected_plot_period_key)
                else:
                    st.info(f"é¸æŠæœŸé–“ ({selected_plot_period_key}) ã§æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ï¼ˆè¤‡æ•°æ—¥ï¼‰ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
            else:
                st.info("æŠ½å‡ºã•ã‚ŒãŸéŠ˜æŸ„ã«ã€é¸æŠæœŸé–“ã§æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        elif extracted_tickers:
            st.info(f"é¸æŠæœŸé–“ ({selected_plot_period_key}) ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€ã¾ãŸã¯éŠ˜æŸ„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        
        # ====================================================================
        # ğŸ’¡ è¿½åŠ : 3ã¤ç›®ã®ã‚°ãƒ©ãƒ•ï¼ˆã•ã‚‰ã«åˆ¥æœŸé–“ã§ã®æ ªä¾¡å¤‰å‹•ç‡ã‚°ãƒ©ãƒ•ï¼‰- ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆå¯¾å¿œ
        # ====================================================================
        st.markdown("---")
        st.markdown("### ğŸ“ˆ é•·æœŸé–“")
        
        target_period_key_3 = "3å¹´"
        target_index_3 = period_options.index(target_period_key_3) if target_period_key_3 in period_options else 0

        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã«æŠ½å‡ºéŠ˜æŸ„ãƒªã‚¹ãƒˆã‚’ä¿å­˜ï¼ˆåˆæœŸå€¤ã¨ã—ã¦ä½¿ç”¨ï¼‰
        if "selected_plot_tickers_3" not in st.session_state:
             # åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã€ã¾ãŸã¯æŠ½å‡ºéŠ˜æŸ„ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã«æ›´æ–°
            st.session_state.selected_plot_tickers_3 = extracted_tickers
            
        # Yè»¸è¨­å®šç”¨ã®åˆ—ã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹
        col_plot_period_3,col_plot_y_setting_3 , col_multiselect_3 = st.columns([1, 1, 4]) # åˆ—å¹…ã‚’èª¿æ•´

        with col_plot_period_3:
            st.markdown("æœŸé–“") 
            selected_plot_period_key_3 = st.selectbox(
                "3ã¤ç›®ã®ã‚°ãƒ©ãƒ•æç”»æœŸé–“ã‚’é¸æŠ",
                options=period_options,
                index=period_options.index(st.session_state.get("selectbox_plot_period_3", target_period_key_3)) 
                             if st.session_state.get("selectbox_plot_period_3", target_period_key_3) in period_options else 
                             target_index_3,
                key="selectbox_plot_period_3",
                label_visibility="collapsed"
            )

        with col_multiselect_3:
            st.markdown("éŠ˜æŸ„") 
            selected_plot_ticker_names_3 = st.multiselect(
                "æç”»éŠ˜æŸ„ã‚’é¸æŠï¼ˆ3ã¤ç›®ï¼‰",
                options=extracted_stock_options,
                default=[FILTERED_STOCKS[t] for t in st.session_state.selected_plot_tickers_3 if FILTERED_STOCKS[t] in extracted_stock_options],
                key="multiselect_plot_tickers_3",
                label_visibility="collapsed"
            )
            # é¸æŠã•ã‚ŒãŸéŠ˜æŸ„åã‹ã‚‰ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°
            selected_plot_tickers_3 = [name_to_ticker.get(name) for name in selected_plot_ticker_names_3 if name in name_to_ticker]
            st.session_state.selected_plot_tickers_3 = selected_plot_tickers_3 # æ¬¡å›ã®åˆæœŸå€¤ã®ãŸã‚ã«ä¿å­˜

        # ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 10: 3ã¤ç›®ã®ã‚°ãƒ©ãƒ•ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚‚ã€Œ5æ—¥ã€ã«å¯¾å¿œ
        data_plot_for_analysis_3 = pd.DataFrame()
        if selected_plot_period_key_3 in ["5æ—¥", "1ãƒ¶æœˆ"]:
            yf_period_str_3 = "5d" if selected_plot_period_key_3 == "5æ—¥" else "1mo"
            with st.spinner(f"æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ï¼ˆ{selected_plot_period_key_3}ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­..."):
                data_plot_for_analysis_3 = load_daily_data_cached(ALL_TICKERS_WITH_N225, yf_period_str_3)
            data_plot_filtered_by_period_3 = data_plot_for_analysis_3
        else:
            data_plot_filtered_by_period_3 = filter_data_by_period(data_raw_5y, selected_plot_period_key_3)

        plot_y_min_default_3 = 0.9
        plot_y_max_default_3 = 5.0
        with col_plot_y_setting_3:
            st.markdown("Yè»¸") 
            y_max_plot_period_3 = st.number_input(
                "Yè»¸ æœ€å¤§å€¤ï¼ˆ3ã¤ç›®ï¼‰",
                min_value=0.1,
                max_value=10.0,
                value=plot_y_max_default_3,
                step=0.05,
                format="%.2f",
                key="y_max_plot_period_3",
                label_visibility="collapsed"
            )
            y_min_plot_period_3 = st.number_input(
                "Yè»¸ æœ€å°å€¤ï¼ˆ3ã¤ç›®ï¼‰",
                min_value=0.0,
                max_value=4.9,
                value=plot_y_min_default_3,
                step=0.05,
                format="%.2f",
                key="y_min_plot_period_3",
                label_visibility="collapsed"
            )

        if y_min_plot_period_3 >= y_max_plot_period_3:
            st.warning("3ã¤ç›®ã®ã‚°ãƒ©ãƒ•ã®Yè»¸è¨­å®šãŒä¸æ­£ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æç”»ã—ã¾ã™ã€‚")
            y_min_plot_period_3 = plot_y_min_default_3
            y_max_plot_period_3 = plot_y_max_default_3

        # ğŸ’¡ ä¿®æ­£å¾Œ: æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æç”» (å¤‰æ›´ãªã—)
        if not data_plot_filtered_by_period_3.empty and selected_plot_tickers_3: # <--- é¸æŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’ä½¿ç”¨
            plot_tickers_new_3 = [t for t in selected_plot_tickers_3 if t in data_plot_filtered_by_period_3.columns]
            if '^N225' in data_plot_filtered_by_period_3.columns:
                plot_tickers_new_3.append('^N225')

            if plot_tickers_new_3:
                plot_data_raw_new_3 = data_plot_filtered_by_period_3[[c for c in plot_tickers_new_3 if c in data_plot_filtered_by_period_3.columns]].copy()
                
                if not plot_data_raw_new_3.empty and plot_data_raw_new_3.shape[0] > 1:
                    # æ­£è¦åŒ–ã®åŸºæº–ã¯æœŸé–“ã®æœ€åˆã®ãƒ‡ãƒ¼ã‚¿
                    first_valid_price_3 = plot_data_raw_new_3.iloc[0]
                    extracted_normalized_new_3 = plot_data_raw_new_3 / first_valid_price_3
                    
                    # ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 11: selected_plot_period_key_3ãŒã€Œ5æ—¥ã€ã«å¯¾å¿œ
                    create_and_display_charts(
                        extracted_normalized_new_3,
                        selected_plot_period_key_3,
                        y_min_plot_period_3,
                        y_max_plot_period_3,
                        selected_plot_period_key_3
                    )
                else:
                    st.info(f"é¸æŠæœŸé–“ ({selected_plot_period_key_3}) ã§æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ï¼ˆè¤‡æ•°æ—¥ï¼‰ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
            else:
                st.info("æŠ½å‡ºã•ã‚ŒãŸéŠ˜æŸ„ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        elif extracted_tickers:
            st.info(f"é¸æŠæœŸé–“ ({selected_plot_period_key_3}) ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€ã¾ãŸã¯éŠ˜æŸ„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        # ====================================================================
        # ğŸ’¡ è¿½åŠ ã“ã“ã¾ã§
        # ====================================================================
            
        else:
            st.info(f"ã“ã®æœŸé–“ã«æ ªä¾¡å¤‰å‹•ç‡ãŒ {min_gain_threshold:.2f}% ï½ {max_gain_threshold:.2f}% ã®éŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚") 
else:
    if data_filtered_by_period.empty:
        # ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã€ã‚ˆã‚Šå…·ä½“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
        # ğŸ”¥ å¤‰æ›´ç®‡æ‰€ 12: "1æ—¥" ã‚’ "5æ—¥" ã«å¤‰æ›´
        if selected_period_key in ["5æ—¥", "1ãƒ¶æœˆ"]:
            st.info(f"é¸æŠæœŸé–“ ({selected_period_key}) ã®æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã‹ã£ãŸãŸã‚ã€éŠ˜æŸ„æŠ½å‡ºãŒè¡Œãˆã¾ã›ã‚“ã§ã—ãŸã€‚")
        else:
             st.info(f"é¸æŠæœŸé–“ ({selected_period_key}) ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    else:
        st.info(f"ã“ã®æœŸé–“ã«æ ªä¾¡å¤‰å‹•ç‡ãŒ {min_gain_threshold:.2f}% ï½ {max_gain_threshold:.2f}% ã®éŠ˜æŸ„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")